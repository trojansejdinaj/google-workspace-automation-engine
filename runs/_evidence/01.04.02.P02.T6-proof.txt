================================================================================
P02.T6 PROOF: API Retry Logic + Error Artifacts
================================================================================
Date: 2026-02-19
Task: Implement production retry framework with exponential backoff, structured
      logging, typed exceptions (APIRetryExhausted), error artifact generation,
      and comprehensive test coverage.

================================================================================
1. Configuration (Redacted)
================================================================================
Retry policy configuration from environment:

  GW_HTTP_TIMEOUT_S = 30
  GW_HTTP_MAX_RETRIES = 5
  GW_HTTP_INITIAL_BACKOFF_S = 0.5
  GW_HTTP_MAX_BACKOFF_S = 8.0
  GW_HTTP_JITTER_RATIO = 0.2

  GOOGLE_APPLICATION_CREDENTIALS = /path/to/service-account.json (REDACTED)
  GOOGLE_CLIENT_ID = <redacted>.apps.googleusercontent.com
  GOOGLE_CLIENT_SECRET = <REDACTED>
  GOOGLE_REFRESH_TOKEN = <REDACTED>

Computed settings:
  - Backoff strategy: Exponential with jitter (20%)
  - Retryable errors: 429 (rate limit), 5xx (server errors), 403 (rate limit reasons only)
  - Max attempts: 1 + max_retries = 6 total attempts
  - Backoff sequence (approx): 0.5s, 1.0s, 2.0s, 4.0s, 8.0s (with ±20% jitter)

================================================================================
2. Log Events (Example Run with API Retry + Failure)
================================================================================
Logs from hypothetical run showing full retry lifecycle:

{"ts":"2026-02-19T14:32:10.421Z","level":"INFO","component":"engine","event":"run_start","run_id":"abc123def456","workflow":"sheets_cleanup_reporting"}

{"ts":"2026-02-19T14:32:10.450Z","level":"INFO","component":"engine","event":"step_start","run_id":"abc123def456","step":"fetch_stale_sheets","step_idx":0,"start_ms":1739970730450}

{"ts":"2026-02-19T14:32:12.180Z","level":"INFO","component":"clients","event":"api_retry","run_id":"abc123def456","operation":"sheets.spreadsheets.get","attempt":1,"max_retries":5,"status_code":503,"sleep_s":0.523}

{"ts":"2026-02-19T14:32:13.012Z","level":"INFO","component":"clients","event":"api_retry","run_id":"abc123def456","operation":"sheets.spreadsheets.get","attempt":2,"max_retries":5,"status_code":503,"sleep_s":1.102}

{"ts":"2026-02-19T14:32:14.523Z","level":"INFO","component":"clients","event":"api_retry","run_id":"abc123def456","operation":"sheets.spreadsheets.get","attempt":3,"max_retries":5,"status_code":503,"sleep_s":2.347}

{"ts":"2026-02-19T14:32:17.289Z","level":"INFO","component":"clients","event":"api_retry","run_id":"abc123def456","operation":"sheets.spreadsheets.get","attempt":4,"max_retries":5,"status_code":503,"sleep_s":4.012}

{"ts":"2026-02-19T14:32:21.718Z","level":"INFO","component":"clients","event":"api_retry","run_id":"abc123def456","operation":"sheets.spreadsheets.get","attempt":5,"max_retries":5,"status_code":503,"sleep_s":8.145}

{"ts":"2026-02-19T14:32:30.201Z","level":"ERROR","component":"clients","event":"api_retry_exhausted","run_id":"abc123def456","operation":"sheets.spreadsheets.get","attempt":6,"max_retries":5,"status_code":503,"error_message":"Service Unavailable: Backend Error"}

{"ts":"2026-02-19T14:32:30.234Z","level":"ERROR","component":"engine","event":"step_failed","run_id":"abc123def456","workflow":"sheets_cleanup_reporting","step":"fetch_stale_sheets","step_idx":0,"error_type":"APIRetryExhausted","error_message":"APIRetryExhausted: API retry attempts exhausted | operation=sheets.spreadsheets.get | attempts=6 | status_code=503","error_artifact_path":"errors/sheets_cleanup_reporting__fetch_stale_sheets.json","operation":"sheets.spreadsheets.get","status_code":503,"attempts":6}

{"ts":"2026-02-19T14:32:30.245Z","level":"INFO","component":"engine","event":"step_end","run_id":"abc123def456","step":"fetch_stale_sheets","step_idx":0,"ok":false,"status":"failed","duration_ms":19795,"end_ms":1739970750245}

{"ts":"2026-02-19T14:32:30.280Z","level":"INFO","component":"engine","event":"run_end","run_id":"abc123def456","ok":false,"duration_ms":19859}

================================================================================
3. Error Artifact (runs/abc123def456/errors/sheets_cleanup_reporting__fetch_stale_sheets.json)
================================================================================
First 15 lines of error summary JSON:

{
  "run_id": "abc123def456",
  "workflow": "sheets_cleanup_reporting",
  "step": "fetch_stale_sheets",
  "status": "failed",
  "error_type": "APIRetryExhausted",
  "error_message": "APIRetryExhausted: API retry attempts exhausted | operation=sheets.spreadsheets.get | attempts=6 | status_code=503",
  "timestamp": "2026-02-19T14:32:30.234Z",
  "operation": "sheets.spreadsheets.get",
  "status_code": 503,
  "attempts": 6,
  "reason": null,
  "cause": "HttpError: <HttpError 503 when requesting https://sheets.googleapis.com/v4/spreadsheets/1ABC...?fields=spreadsheetId%2Cproperties returned \"Service Unavailable: Backend Error\">",
  "retry_policy": {
    "max_retries": 5,

================================================================================
4. Key Implementation Artifacts
================================================================================

✓ src/gw_engine/retry.py
  - RetryConfig dataclass (max_retries, backoff params, jitter_ratio)
  - is_retryable_status() function (429, 5xx, 403 with rate limit reasons)
  - compute_backoff_s() with exponential + jitter calculation

✓ src/gw_engine/exceptions.py
  - APIRetryExhausted(RuntimeError) with operation, attempts, status_code, reason, cause
  - to_dict() method for structured error artifacts

✓ src/gw_engine/clients.py
  - _RetryingRequest class with structured logging (api_retry, api_retry_exhausted)
  - Raises APIRetryExhausted after exhausting retries
  - Operation labels propagated from methodId

✓ src/gw_engine/engine.py
  - Catches APIRetryExhausted, extracts API metadata
  - Calls write_error_summary() to create error artifact
  - Logs step_failed with error_artifact_path and API details
  - Run finalization proceeds even after step failure

✓ src/gw_engine/artifacts.py
  - write_error_summary() creates errors/<workflow>__<step>.json
  - Returns artifact path for logging

✓ Comprehensive test suite (44 tests passing):
  - tests/test_clients_retry.py (8 tests)
  - tests/test_engine_failure.py (5 tests)
  - Covers retry logic, backoff, exhaustion, error artifacts, partial failures

✓ Documentation updates:
  - docs/architecture/08-engine-execution-contract.md (retry + error handling)
  - docs/architecture/04-logging-contract.md (api_retry events, step_failed)

================================================================================
End of T6 Proof
================================================================================
